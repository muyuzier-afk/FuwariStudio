name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g. v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - name: Create GitHub release (if missing)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release already exists: $TAG"
            exit 0
          fi
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "Automated build for $TAG."

  build_android:
    runs-on: ubuntu-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup Android signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret; building unsigned (debug signing)."
            exit 0
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/upload.jks
          cat > android/key.properties <<EOF
          storeFile=upload.jks
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          EOF
      - name: Verify version matches tag
        env:
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          PUBSPEC_VERSION=$(grep -E '^version:' pubspec.yaml | awk '{print $2}')
          CORE=${PUBSPEC_VERSION%%+*}
          TAG_CORE=${TAG#v}
          if [ "$CORE" != "$TAG_CORE" ]; then
            echo "pubspec.yaml version ($CORE) does not match tag ($TAG_CORE)"
            exit 1
          fi
      - name: Build (APK)
        run: |
          flutter pub get
          flutter test
          flutter build apk --release
      - name: Upload APK to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          APK_IN=build/app/outputs/flutter-apk/app-release.apk
          APK_OUT="FuwariStudio-${TAG}-android.apk"
          cp "$APK_IN" "$APK_OUT"
          gh release upload "$TAG" "$APK_OUT" --clobber

  build_windows:
    runs-on: windows-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Verify version matches tag
        env:
          TAG: ${{ inputs.tag || github.ref_name }}
        shell: pwsh
        run: |
          $versionLine = Get-Content pubspec.yaml | Where-Object { $_ -match '^\s*version:\s*' } | Select-Object -First 1
          if (-not $versionLine) { throw "Unable to parse pubspec.yaml version" }
          $version = ($versionLine -replace '^\s*version:\s*', '').Trim()
          $core = $version.Split('+')[0]
          $tagCore = $env:TAG.TrimStart('v')
          if ($core -ne $tagCore) {
            throw "pubspec.yaml version ($core) does not match tag ($tagCore)"
          }
      - name: Build (single-file EXE)
        shell: pwsh
        run: |
          flutter pub get
          flutter test
          pwsh -ExecutionPolicy Bypass -File scripts/build_windows_exe.ps1 -Flutter flutter -VersionTag "${{ inputs.tag || github.ref_name }}"
      - name: Upload EXE to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        shell: pwsh
        run: |
          $exe = Join-Path $PWD "dist/windows/FuwariStudio-$env:TAG-win-x64.exe"
          if (!(Test-Path $exe)) { throw "Missing: $exe" }
          gh release upload $env:TAG $exe --clobber
