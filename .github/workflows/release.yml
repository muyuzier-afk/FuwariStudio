name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub release (if missing)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release already exists: $TAG"
            exit 0
          fi
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "Automated build for $TAG."

  build_android:
    runs-on: ubuntu-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Verify version matches tag
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          PUBSPEC_VERSION=$(grep -E '^version:' pubspec.yaml | awk '{print $2}')
          CORE=${PUBSPEC_VERSION%%+*}
          TAG_CORE=${TAG#v}
          if [ "$CORE" != "$TAG_CORE" ]; then
            echo "pubspec.yaml version ($CORE) does not match tag ($TAG_CORE)"
            exit 1
          fi
      - name: Build (APK)
        run: |
          flutter pub get
          flutter test
          flutter build apk --release
      - name: Upload APK to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          APK_IN=build/app/outputs/flutter-apk/app-release.apk
          APK_OUT="FuwariStudio-${TAG}-android.apk"
          cp "$APK_IN" "$APK_OUT"
          gh release upload "$TAG" "$APK_OUT" --clobber

  build_windows:
    runs-on: windows-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Verify version matches tag
        env:
          TAG: ${{ github.ref_name }}
        shell: pwsh
        run: |
          $pubspec = Get-Content pubspec.yaml -Raw
          if ($pubspec -match '(?m)^version:\\s*([^\\s]+)\\s*$') {
            $version = $Matches[1]
          } else {
            throw "Unable to parse pubspec.yaml version"
          }
          $core = $version.Split('+')[0]
          $tagCore = $env:TAG.TrimStart('v')
          if ($core -ne $tagCore) {
            throw "pubspec.yaml version ($core) does not match tag ($tagCore)"
          }
      - name: Build (single-file EXE)
        shell: pwsh
        run: |
          flutter pub get
          flutter test
          pwsh -ExecutionPolicy Bypass -File scripts/build_windows_exe.ps1 -Flutter flutter -VersionTag "${{ github.ref_name }}"
      - name: Upload EXE to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        shell: pwsh
        run: |
          $exe = Join-Path $PWD "dist/windows/FuwariStudio-$env:TAG-win-x64.exe"
          if (!(Test-Path $exe)) { throw "Missing: $exe" }
          gh release upload $env:TAG $exe --clobber

