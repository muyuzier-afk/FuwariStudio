name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g. v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - name: Create GitHub release (if missing)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release already exists: $TAG"
            exit 0
          fi
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "Automated build for $TAG."

  build_android:
    runs-on: ubuntu-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup Android signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret; building unsigned (debug signing)."
            exit 0
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/upload.jks
          cat > android/key.properties <<EOF
          storeFile=upload.jks
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          EOF
      - name: Verify version matches tag
        env:
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          PUBSPEC_VERSION=$(grep -E '^version:' pubspec.yaml | awk '{print $2}')
          CORE=${PUBSPEC_VERSION%%+*}
          BUILD=""
          if [[ "$PUBSPEC_VERSION" == *"+"* ]]; then
            BUILD=${PUBSPEC_VERSION##*+}
          fi

          TAG_CORE=${TAG#v}
          if [[ "$TAG_CORE" == *.*.*.* ]]; then
            TAG_CORE_3=${TAG_CORE%.*}
            TAG_BUILD=${TAG_CORE##*.}
            if [ "$CORE" != "$TAG_CORE_3" ] || [ "$BUILD" != "$TAG_BUILD" ]; then
              echo "pubspec.yaml version ($CORE+$BUILD) does not match tag ($TAG_CORE)"
              exit 1
            fi
          else
            if [ "$CORE" != "$TAG_CORE" ]; then
              echo "pubspec.yaml version ($CORE) does not match tag ($TAG_CORE)"
              exit 1
            fi
          fi
      - name: Build (APK)
        run: |
          flutter pub get
          flutter test
          flutter build apk --release
      - name: Upload APK to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          set -euo pipefail
          APK_IN=build/app/outputs/flutter-apk/app-release.apk
          APK_OUT="FuwariStudio-${TAG}-android.apk"
          cp "$APK_IN" "$APK_OUT"
          gh release upload "$TAG" "$APK_OUT" --clobber

  build_windows:
    runs-on: windows-latest
    needs: create_release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Verify version matches tag
        env:
          TAG: ${{ inputs.tag || github.ref_name }}
        shell: pwsh
        run: |
          $versionLine = Get-Content pubspec.yaml | Where-Object { $_ -match '^\s*version:\s*' } | Select-Object -First 1
          if (-not $versionLine) { throw "Unable to parse pubspec.yaml version" }
          $version = ($versionLine -replace '^\s*version:\s*', '').Trim()
          $core = $version.Split('+')[0]
          $build = ($version.Contains('+')) ? $version.Split('+')[1] : ''
          $tagCore = $env:TAG.TrimStart('v')
          if (($tagCore -split '\.').Count -ge 4) {
            $tagParts = $tagCore.Split('.')
            $tagCore3 = ($tagParts[0..2] -join '.')
            $tagBuild = $tagParts[3]
            if ($core -ne $tagCore3 -or $build -ne $tagBuild) {
              throw "pubspec.yaml version ($core+$build) does not match tag ($tagCore)"
            }
          } else {
            if ($core -ne $tagCore) {
              throw "pubspec.yaml version ($core) does not match tag ($tagCore)"
            }
          }

      - name: Build (MSI installer)
        shell: pwsh
        run: |
          flutter pub get
          flutter test
          pwsh -ExecutionPolicy Bypass -File scripts/build_msi.ps1 -Flutter flutter

      - name: Sign MSI (optional)
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
          WINDOWS_SIGN_TIMESTAMP_URL: ${{ secrets.WINDOWS_SIGN_TIMESTAMP_URL }}
        shell: pwsh
        run: |
          if (-not $env:WINDOWS_PFX_BASE64) {
            Write-Host "No WINDOWS_PFX_BASE64 secret; skip signing."
            exit 0
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))

          $signtool = (Get-Command signtool.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $signtool) {
            $candidates = @(
              "${env:ProgramFiles(x86)}\Windows Kits\10\bin\x64\signtool.exe",
              "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe",
              "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22000.0\x64\signtool.exe"
            ) | Where-Object { Test-Path $_ }
            $signtool = $candidates | Select-Object -First 1
          }
          if (-not $signtool) {
            Write-Host "signtool.exe not found; skip signing."
            exit 0
          }

          $msi = Get-ChildItem "dist/windows" -Filter "*.msi" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $msi) { throw "No MSI found in dist/windows" }

          $tr = $env:WINDOWS_SIGN_TIMESTAMP_URL
          if (-not $tr) { $tr = "http://timestamp.digicert.com" }

          & $signtool sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd sha256 /tr $tr /td sha256 $msi.FullName
          if ($LASTEXITCODE -ne 0) { throw "signtool failed with exit code $LASTEXITCODE" }

      - name: Upload MSI to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag || github.ref_name }}
        shell: pwsh
        run: |
          $msi = Get-ChildItem "dist/windows" -Filter "*.msi" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $msi) { throw "Missing MSI in dist/windows" }
          gh release upload $env:TAG $msi.FullName --clobber
